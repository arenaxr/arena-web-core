<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Sign In to the ARENA</title>
    <link rel="icon" type="image/png" href="//xr.andrew.cmu.edu/conix-x.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" type="text/css" href="./style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <script src="https://apis.google.com/js/api:client.js"></script>
    <script src="../defaults.js"></script>
    <script src="../auth.js"></script>
</head>

<body>
    <div class="bg-img">
        <form method="post" action="" class="login login-form">
            <h1>Sign In to the ARENA</h1>
            <!-- <input type="text" placeholder="Username or email id" name="login" required />
            <input type="password" placeholder="Enter password" name="psw" required />
            <button type="submit">Login</button>

            <label class="remember-me"><input type="checkbox" name="remember" />Remember me</label>
            <span class="forget-psw">Forgot <a href="#">password?</a></span> -->

            <!-- <div class="social-btn"> -->
            <!-- <div class="fa g-signin2" data-onsuccess="onGoogleSignIn"></div> -->
            <div id="gSignInWrapper">
                <div id="customBtnGoogle" class="customBtn">
                    <span class="icon"></span>
                    <span class="buttonText">Google</span>
                </div>
            </div>
            <!-- <button type="submit" class="github-btn">
                    <i class="fab fa-github" aria-hidden="true"></i> Login
                    with Github
                </button> -->
            <div id="anonSignInWrapper">
                <div id="customBtnAnon" class="customBtn">
                    <span class="icon">
                        <i class="fa fa-user-secret"></i>
                    </span>
                    <span class="buttonText">Anonymously</span>
                </div>
            </div>
            <!-- </div> -->
            <div hidden id="anonNameWrapper">Great! Your preferred name is...<input type="text"
                    placeholder="Hi! My name is..." id="usernameInput" />
                <button id="btnAnonName" type="button">Enter</button>
            </div>
        </form>
    </div>
</body>

<script>
    "use strict";

    // TODO(mwfarb): App Store iOS build of WebXRViewer, G-Auth rejects the UA with 403

    // browser detection is not fun...
    var is_safari = navigator.userAgent.indexOf("Safari") > -1;
    var is_chrome = navigator.userAgent.indexOf('Chrome') > -1 || navigator.userAgent.indexOf('ChiOS') > -1;
    var is_firefox = navigator.userAgent.indexOf('Firefox') > -1 || navigator.userAgent.indexOf('FxiOS') > -1;
    var is_webxrviewer = navigator.userAgent.indexOf('WebXRViewer') > -1;
    var is_explorer = navigator.userAgent.indexOf('MSIE') > -1;
    var is_edge = navigator.userAgent.indexOf('Edg') > -1;
    var is_opera = navigator.userAgent.toLowerCase().indexOf("op") > -1;
    if ((is_edge) && (is_safari)) { is_safari = false; }
    if ((is_firefox) && (is_safari)) { is_safari = false; }
    if ((is_chrome) && (is_safari)) { is_safari = false; }
    if ((is_chrome) && (is_opera)) { is_chrome = false; }

    var urlParts = location.href.split("/");
    var rootPath = urlParts[0] + "//" + urlParts[2];

    const popupConfig = {
        client_id: defaults.gAuthClientId,
    };
    const redirectConfig = {
        client_id: defaults.gAuthClientId,
        ux_mode: 'redirect',
        redirect_uri: rootPath + '/signin/google/',
    };
    const gapiInitConfig = is_safari ? popupConfig : redirectConfig;
    var auth2;
    var googleUser = {};
    var initGoogleAuth = function () {
        gapi.load('auth2', function () {
            auth2 = gapi.auth2.init(gapiInitConfig).then(function () {
                attachGoogleSignin(document.getElementById('customBtnGoogle'));
                auth2 = gapi.auth2.getAuthInstance();
                if (auth2.isSignedIn.get()) {
                    console.log("User is already signed in.");
                    var googleUser = auth2.currentUser.get();
                    onGoogleSignIn(googleUser);
                }
            }, function (error) {
                console.error(error);
                // TODO(mwfarb): gray out google button?
            });
        });
    };

    function attachGoogleSignin(element) {
        auth2.attachClickHandler(element, {}, onGoogleSignIn, function (error) {
            alert(JSON.stringify(error, undefined, 2));
        });
    }

    function onGoogleSignIn(googleUser) {
        var profile = googleUser.getBasicProfile();
        console.log("Signed In: " + profile.getEmail());
        localStorage.setItem("auth_choice", "google");
        returnToRequestedPage();
    }

    function returnToRequestedPage() {
        if (localStorage.getItem("request_uri")) {
            //redirect user to originally requested page
            location.href = localStorage.getItem("request_uri");
        } else {
            location.href = ".."; // back to main ARENA
        }
    }

    const nameRegex = "^(?=[^A-Za-z]*[A-Za-z]{2,})[ -~]*$";
    var initAnonAuth = function () {
        var re = new RegExp(nameRegex);
        var anonBtn = document.getElementById('customBtnAnon');
        if (typeof anonBtn != 'undefined') {
            anonBtn.addEventListener('click', function (event) {
                // check for saved name, use it
                var savedName = localStorage.getItem("display_name");
                if (savedName !== null && re.test(savedName)) {
                    localStorage.setItem("auth_choice", "anonymous");
                    returnToRequestedPage();
                } else { // if no passable name, ask for one
                    var namePanel = document.getElementById('anonNameWrapper');
                    namePanel.hidden = false;
                }
            });
        }
        var usernameInput = document.getElementById('usernameInput');
        usernameInput.setAttribute("pattern", nameRegex);
        var nameBtn = document.getElementById('btnAnonName');
        nameBtn.addEventListener('click', function (event) {
            // validate
            if (re.test(usernameInput.value)) {
                // remove extra spaces
                var displayName = usernameInput.value.replace(/\s+/g, " ").trim();
                localStorage.setItem("display_name", displayName);  // save for next use
                localStorage.setItem("auth_choice", "anonymous");
                returnToRequestedPage();
            }
        });
    }

    initGoogleAuth();
    initAnonAuth();
</script>

</html>
